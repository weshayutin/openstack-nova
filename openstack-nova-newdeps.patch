From 17ce490483d8da9cb2ff859c07ff88f809e335d3 Mon Sep 17 00:00:00 2001
From: Nikola Dipanov <ndipanov@redhat.com>
Date: Mon, 10 Jun 2013 10:24:55 +0200
Subject: [PATCH] openstack-nova-new-deps

Change-Id: I06793fee68ef2847899aa712d3f10aa2fd3887e9
---
 nova/__init__.py                |   30 ++++++++++++++++++++++++++++++
 nova/db/sqlalchemy/migration.py |    8 +++++++-
 2 files changed, 37 insertions(+), 1 deletion(-)

diff --git a/nova/__init__.py b/nova/__init__.py
index e21bdd7..ee3e322 100644
--- a/nova/__init__.py
+++ b/nova/__init__.py
@@ -24,3 +24,33 @@
    :platform: Unix
    :synopsis: Infrastructure-as-a-Service Cloud platform.
 """
+
+import sys
+import pkg_resources
+
+# If there is a conflicting non egg module,
+# i.e. an older standard system module installed,
+# then replace it with this requirement
+def replace_dist(requirement):
+    try:
+        return pkg_resources.require(requirement)
+    except pkg_resources.VersionConflict:
+        e = sys.exc_info()[1]
+        dist=e.args[0]
+        req=e.args[1]
+        if dist.key == req.key and not dist.location.endswith('.egg'):
+            del pkg_resources.working_set.by_key[dist.key]
+            # We assume there is no need to adjust sys.path
+            # and the associated pkg_resources.working_set.entries
+            return pkg_resources.require(requirement)
+
+replace_dist("WebOb >= 1.0")
+replace_dist("SQLAlchemy >= 0.6.3")
+replace_dist("Routes >= 1.12.3")
+
+replace_dist("PasteDeploy >= 1.5.0")
+# This hack is needed because replace_dist() results in
+# the standard paste module path being at the start of __path__.
+# TODO: See can we get pkg_resources to do the right thing directly
+import paste
+paste.__path__.insert(0, paste.__path__.pop(-1))
diff --git a/nova/db/sqlalchemy/migration.py b/nova/db/sqlalchemy/migration.py
index 14758ab..a9727e3 100644
--- a/nova/db/sqlalchemy/migration.py
+++ b/nova/db/sqlalchemy/migration.py
@@ -52,7 +52,13 @@ if (not hasattr(migrate, '__version__') or
 
 
 # NOTE(jkoelker) Delay importing migrate until we are patched
-from migrate import exceptions as versioning_exceptions
+try:
+    # Try the more specific path first (migrate <= 0.6)
+    from migrate.versioning import exceptions as versioning_exceptions
+except ImportError:
+    # Use the newer path (migrate >= 0.7)
+    from migrate import exceptions as versioning_exceptions
+
 from migrate.versioning import api as versioning_api
 from migrate.versioning.repository import Repository
 
-- 
1.7.9.5

